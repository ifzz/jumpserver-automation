<div id="tasks">
    <select id="all_task" onchange="getTask(this.options[this.options.selectedIndex].value)"><option>select</option></select>
    <button onclick="updateTask()">更新</button><button onclick="del()">删除</button>
    &nbsp
    Jumpserver Username：<input id="user" type="text" />
    Password：<input id="password" type="password" />
    <button onclick="login()">登录</button>
    <input id="mfa" type="text" />
    <button onclick="mfalogin()">输入MFA</button>
    &nbsp
    <button onclick="execute()">执行</button>
    任务名：<input id="taskName" type="text" /><button onclick="save()">新建任务</button>
    <br/>
    <textarea id="task" style="overflow:auto; height: 100px; width: 100%; border: 1px solid #999;"></textarea>
</div>

<hr/>
<hr/>
<!-- the messages will be shown here -->
<div  id="scrolldIV" style="overflow:auto; height: 500px; width: 100%; border: 1px solid #999; color: red">
    <b><pre id="output" ></pre></b>
</div>

<!-- import the iris client-side library for browser-->
<script src="/iris-ws.js"></script>

<script>
    var scheme = document.location.protocol == "https:" ? "wss" : "ws";
    var port = document.location.port ? (":" + document.location.port) : "";
    // see app.Get("/echo", ws.Handler()) on main.go
    var wsURL = scheme + "://" + document.location.hostname + port+"/echo";

    var output = document.getElementById("output");

    // Ws comes from the auto-served '/iris-ws.js'
    var socket = new Ws(wsURL)
    socket.OnConnect(function () {
        output.innerHTML += "Status: Connected\n";
    });

    socket.OnDisconnect(function () {
        output.innerHTML += "Status: Disconnected\n";
    });

    // read events from the server
    socket.On("chat", function (msg) {
        addMessage(msg);
    });


    function addMessage(msg) {
        output.innerHTML += msg + "\n";
        add()
        if(msg.indexOf("[MFA auth]:") != -1){
            document.getElementById("mfa").value = msg
        }
    }

    function add() {
        var div = document.getElementById('scrolldIV');
        div.scrollTop = div.scrollHeight;
    }

    function login() {
        user = document.getElementById("user").value;
        password = document.getElementById("password").value;
        //console.log(user,password)
        socket.Emit("chat", "jump|"+user+"|"+password);
    }

    function mfalogin() {
        socket.Emit("chat", document.getElementById("mfa").value);
    }

    window.onload=function (){

        loadTasks();

    };

    // 创建查询员工方法
    function loadTasks() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/tasks/list');
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    var data = JSON.parse(xhr.responseText); //json解析方法JSON.parse 或者 eval('('+xhr.responseText+')')
                    for (var o in data){
                        console.log(o,data[o]);
                        document.getElementById("all_task").innerHTML += '<option>'+o+'</option>'
                    }
                }
            }
        }
    }
    function getTask(id) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/task?id='+id);
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    console.log(xhr.responseText);
                    document.getElementById("task").value=xhr.responseText;
                }
            }
        }
    }

    function updateTask() {
        var task =  document.getElementById("task").value;
        var obj = document.getElementById("all_task");
        var index = obj.selectedIndex; // 选中索引
        var text = obj.options[index].text; // 选中文本
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/task/update?id='+text);
        xhr.setRequestHeader("Content-type","application/text");
        xhr.send(task);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    console.log(xhr.responseText);
                    document.getElementById("task").value=xhr.responseText;
                }
            }
        }
    }

    function save() {
        var task =  document.getElementById("task").value;
        var text = document.getElementById("taskName").value; // 选中文本
        console.log(text);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/task/update?id='+text);
        xhr.setRequestHeader("Content-type","application/text");
        xhr.send(task);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    console.log(xhr.responseText);
                    document.getElementById("task").value=xhr.responseText;
                }
            }
        }
    }

    function del() {
        var obj = document.getElementById("all_task");
        var index = obj.selectedIndex; // 选中索引
        var id = obj.options[index].text; // 选中文本
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/task/delete?id='+id);
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    console.log(xhr.responseText);
                    loadTasks();
                }
            }
        }
    }

    function execute() {
        var obj = document.getElementById("all_task");
        var index = obj.selectedIndex; // 选中索引
        var id = obj.options[index].text; // 选中文本
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/task/execute?id=' + id);
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status = 200) {
                    alert(xhr.responseText);
                }
            }
        }
    }

</script>